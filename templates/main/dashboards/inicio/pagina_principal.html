{% extends './partials/system/layout1.html' %}
{% include 'partials/system/flash_alerts.html' %}
{% block content %}
{% include 'partials/system/alerts.html' %}
<div id="main" class=" pt-5">
    <div class="flex flex-col gap-5 overflow-y-auto" style="max-height: calc(100vh - 171px);">
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">

            <div
                class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg space-y-6">
                <div class="flex items-center gap-2.5 justify-center">
                    <span>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M15.6679 7C15.6679 6.58579 16.0037 6.25 16.4179 6.25H22C22.4142 6.25 22.75 6.58579 22.75 7V12.5458C22.75 12.96 22.4142 13.2958 22 13.2958C21.5858 13.2958 21.25 12.96 21.25 12.5458V7.75H16.4179C16.0037 7.75 15.6679 7.41421 15.6679 7Z"
                                fill="#267DFF" />
                            <path opacity="0.3"
                                d="M20.1873 7.75L14.0916 13.8027C13.5778 14.3134 13.2447 14.6423 12.9673 14.8527C12.7073 15.0499 12.5857 15.072 12.5052 15.072C12.4247 15.072 12.3031 15.0499 12.0431 14.8526C11.7658 14.6421 11.4327 14.3132 10.919 13.8024L10.6448 13.5296C10.1755 13.063 9.77105 12.6607 9.40375 12.382C9.01003 12.0832 8.57254 11.8572 8.03395 11.8574C7.49535 11.8576 7.05802 12.0839 6.66452 12.383C6.29742 12.662 5.89326 13.0645 5.42433 13.5315L1.47078 17.4686C1.17728 17.7608 1.17628 18.2357 1.46856 18.5292C1.76084 18.8227 2.23571 18.8237 2.52922 18.5314L6.44789 14.6292C6.96167 14.1175 7.29478 13.7881 7.57219 13.5772C7.83228 13.3795 7.95393 13.3574 8.03449 13.3574C8.11506 13.3573 8.23672 13.3794 8.49695 13.5769C8.77452 13.7875 9.10787 14.1167 9.62203 14.628L9.89627 14.9007C10.3651 15.367 10.7692 15.7688 11.1362 16.0474C11.5297 16.346 11.9668 16.5719 12.505 16.572C13.0432 16.572 13.4804 16.3462 13.8739 16.0477C14.241 15.7692 14.6452 15.3674 15.1142 14.9013L21.2501 8.80858V7.75H20.1873Z"
                                fill="#267DFF" />
                        </svg>
                    </span>
                    <p class="text-3xl font-bold text-slate-800 dark:text-white">Resumen Financiero</p>
                </div>




                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

                    <!-- Tarjeta 1: Total Pagado -->
                    <div class="dark:bg-[#1b2e4b] rounded-xl p-5 shadow-md border-t-4 border-success border">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-success/10 rounded-lg text-success">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                                <span id="kpi_total_pagos" class="text-3xl font-bold text-success">Cargando...</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-500 font-semibold uppercase tracking-wider">TOTAL PAGADO</p>
                            <p class="text-base text-gray-400">Egresos confirmados</p>
                        </div>
                    </div>

                    <!-- Tarjeta 2: Total Gastos -->
                    <div class="dark:bg-[#1b2e4b] rounded-xl p-5 shadow-md border-t-4 border-primary border">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-primary/10 rounded-lg text-primary">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                </div>
                                <span id="kpi_total_gastos"
                                    class="text-3xl font-bold text-slate-800 dark:text-white">Cargando...</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-500 font-semibold uppercase tracking-wider">TOTAL GASTOS</p>
                            <p class="text-base text-gray-400">Basado en registros activos</p>
                        </div>
                    </div>


                    <!-- Tarjeta 3: Por Pagar -->
                    <div class="dark:bg-[#1b2e4b] rounded-xl p-5 shadow-md border-t-4 border-danger border">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-danger/10 rounded-lg text-danger">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                    </svg>
                                </div>
                                <span id="kpi_pendiente" class="text-3xl font-bold text-danger">Cargando...</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-500 font-semibold uppercase tracking-wider">POR PAGAR</p>
                            <p class="text-base text-gray-400">Diferencia pendiente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">

                <div class="p-6 border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 dark:text-white">Tendencia de Gastos Diarios</h3>
                        <p class="text-sm text-slate-500">Visualización de egresos confirmados por fecha</p>
                        <span class="text-lightgray text-sm">$MXN</span>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="compras_diarias_inicio" value="{{fecha_inicio}}" type="date"
                            class="form-input rounded-lg w-full" value="{{fecha_inicio}}"
                            onchange="updateComprasDiarias()"> a
                        <input id="compras_diarias_fin" value="{{fecha_fin}}" type="date"
                            class="form-input rounded-lg w-full" value="{{fecha_fin}}"
                            onchange="updateComprasDiarias()">
                    </div>
                </div>
                <div class="p-6">
                    <div id="grafica_gastos_diarios" class="w-full"></div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5 mb-8">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <div class="flex flex-col mb-4">
                    <h2 class="font-semibold text-slate-800 dark:text-white">Distribución de Gastos</h2>
                </div>
                <div id="grafica_gastos_categorias"></div>
            </div>
        </div>

        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
            <h2 class="font-semibold text-slate-800 dark:text-white">Egresos Mensuales</h2>
            <p class="text-sm text-gray-500">Total pagado por mes</p>
            <span class="text-lightgray text-sm">$MXN</span>
            <div id="grafica_pagos_mensuales"></div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Compras mensuales por producto</h2>
                <div id="grafica_ejemplo"></div>
            </div>
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Detalle de compra</h2>
                <div id="detalle_compras"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <div class="flex justify-between items-center gap-3">
                    <div class="flex flex-col">
                        <h2 class="font-semibold">Compras diarias</h2>
                        <span class="text-lightgray text-sm">$MXN</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="compras_diarias_inicio" value="{{fecha_inicio}}" type="date"
                            class="form-input rounded-lg w-full" value="{{fecha_inicio}}"
                            onchange="updateComprasDiarias()"> a
                        <input id="compras_diarias_fin" value="{{fecha_fin}}" type="date"
                            class="form-input rounded-lg w-full" value="{{fecha_fin}}"
                            onchange="updateComprasDiarias()">
                    </div>
                </div>
                <div id="grafica_compras_diarias"></div>
            </div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <div class="flex justify-between items-center gap-3">
                    <div class="flex flex-col">
                        <h2 class="font-semibold">Transferencias de inventario por producto (mes actual)</h2>
                        <span class="text-lightgray text-sm">Productos con mayor cantidad transferida</span>
                    </div>
                </div>
                <div id="grafica_transferencias_producto"></div>
            </div>
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <div class="flex justify-between items-center gap-3">
                    <div class="flex flex-col">
                        <h2 class="font-semibold">Resumen de inventario</h2>
                        <span class="text-lightgray text-sm">Productos, almacenes y transferencias (mes actual)</span>
                    </div>
                </div>
                <div id="grafica_total_inventario"></div>
            </div>
        </div>

    </div>

</div>
{% include "./partials/system/loader.html" %}
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
<script src="/static/js/system/apex-ecom_copy.js"></script>
<script src="/static/js/system/funciones_generales.js"></script>
<script src="/static/js/charts/general.js"></script>
<script src="/static/js/charts/waterfall.js"></script>
<script>


    async function cargarKPIs() {
        // Obtener fechas de los inputs del dashboard
        const inicio = document.getElementById('compras_diarias_inicio').value;
        const fin = document.getElementById('compras_diarias_fin').value;

        const url = `/dashboard_queries/resumen_financiero?fecha_inicio=${inicio}&fecha_fin=${fin}`;

        try {
            const response = await fetch(url);
            const data = await response.json();


            if (data && data.length > 0) {
                const res = data[0];

                const gastos = parseFloat(res.total_gastos || 0);
                const pagos = parseFloat(res.total_pagos || 0);
                const pendiente = gastos - pagos;

                const formatter = new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN'
                });

                document.getElementById('kpi_total_gastos').innerText = formatter.format(gastos);
                document.getElementById('kpi_total_pagos').innerText = formatter.format(pagos);
                document.getElementById('kpi_pendiente').innerText = formatter.format(pendiente);
            }
        } catch (error) {
            console.error("Error cargando los números:", error);
        }
    }

    updateComprasDiarias()

    // LLamamos a las funciones para inventario

    // Transferencias por producto (usa helper existente en general.js)
    cargar_transferencias_inventario_productos();

    // Resumen total de inventario (productos, almacenes, transferencias)
    cargar_total_inventario();

    document.addEventListener('DOMContentLoaded', () => {
        cargarKPIs();
    });

    generar_grafica_categorias("#grafica_ejemplo", "bar_stacked", 'mes_anio', 'importe_total', 'producto', '/dashboard_queries/compras_mensuales', options = { height: 400, valueType: 'currency' })
    function updateComprasDiarias() {
        const compras_diarias_inicio = document.getElementById('compras_diarias_inicio').value;
        const compras_diarias_fin = document.getElementById('compras_diarias_fin').value;
        generar_grafica(
            '#grafica_compras_diarias',
            'line',
            'fecha',
            'importe_total',
            `/dashboard_queries/compras_diarias?fecha_inicio=${compras_diarias_inicio}&fecha_fin=${compras_diarias_fin}`, { 'valueType': 'currency' }
        )
    }
    function updateTendenciaGastos() {
        const inicio = document.getElementById('compras_diarias_inicio').value;
        const fin = document.getElementById('compras_diarias_fin').value;

        generar_grafica(
            "#grafica_gastos_diarios",
            "area",
            "fecha",
            "total_gastos",
            `/dashboard_queries/gastos_fechas?fecha_inicio=${inicio}&fecha_fin=${fin}`,
            {
                seriesName: "Gasto del día",
                valueType: "currency",
                colors: ["#FF3232"],
                height: 350,
                grid: {
                    padding: {
                        left: 30
                    }
                }
            }
        );
    }
    function updateGastosCategorias() {
        const inicio = document.getElementById('compras_diarias_inicio').value;
        const fin = document.getElementById('compras_diarias_fin').value;

        generar_grafica(
            "#grafica_gastos_categorias",
            "pie",
            "categoria",
            "total",
            `/dashboard_queries/gastos_por_categoria?fecha_inicio=${inicio}&fecha_fin=${fin}`,
            {
                height: 350,
                colors: ["#267DFF", "#FF51A4", "#FF7C51", "#00D085", "#FFC41F"],
                legend: { position: 'bottom' }
            }
        );
    }

    function updatePagosMensuales() {

        generar_grafica_categorias(
            "#grafica_pagos_mensuales",
            "bar_stacked",
            "mes",
            "total_pagado",
            "mes",
            "/dashboard_queries/pagos_por_mes",
            {
                height: 350,
                valueType: 'currency',
                colors: ["#267DFF"],
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        columnWidth: '30%',
                    }
                },
                dataLabels: {
                    formatter: function (val) {
                        return new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN',
                            maximumFractionDigits: 0
                        }).format(val);
                    },
                },
                legend: {
                    show: false // Ocultamos la leyenda para que no se repita el nombre del mes
                }
            }
        );
    }
    updateTendenciaGastos()
    updateComprasDiarias()
    updateGastosCategorias()
    updatePagosMensuales()
    document.addEventListener('DOMContentLoaded', () => {
        cargarKPIs();
        render_dynamic_table("detalle_compras", '/dashboard_queries/tables?path=compras')

    });

</script>
{% endblock content %}
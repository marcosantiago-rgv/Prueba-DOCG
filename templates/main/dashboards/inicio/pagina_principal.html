{% extends './partials/system/layout1.html' %}
{% include 'partials/system/flash_alerts.html' %}
{% block content %}
{% include 'partials/system/alerts.html' %}
<!-- En tu HTML, prueba con este enlace temporal -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
<div id="main" class=" pt-5">
    <div class="flex flex-col gap-5 overflow-y-auto" style="max-height: calc(100vh - 171px);">
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg space-y-6">
                    <div class="flex items-center gap-2.5 justify-center">
                        <span>
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M15.6679 7C15.6679 6.58579 16.0037 6.25 16.4179 6.25H22C22.4142 6.25 22.75 6.58579 22.75 7V12.5458C22.75 12.96 22.4142 13.2958 22 13.2958C21.5858 13.2958 21.25 12.96 21.25 12.5458V7.75H16.4179C16.0037 7.75 15.6679 7.41421 15.6679 7Z" fill="#267DFF" />
                                <path opacity="0.3" d="M20.1873 7.75L14.0916 13.8027C13.5778 14.3134 13.2447 14.6423 12.9673 14.8527C12.7073 15.0499 12.5857 15.072 12.5052 15.072C12.4247 15.072 12.3031 15.0499 12.0431 14.8526C11.7658 14.6421 11.4327 14.3132 10.919 13.8024L10.6448 13.5296C10.1755 13.063 9.77105 12.6607 9.40375 12.382C9.01003 12.0832 8.57254 11.8572 8.03395 11.8574C7.49535 11.8576 7.05802 12.0839 6.66452 12.383C6.29742 12.662 5.89326 13.0645 5.42433 13.5315L1.47078 17.4686C1.17728 17.7608 1.17628 18.2357 1.46856 18.5292C1.76084 18.8227 2.23571 18.8237 2.52922 18.5314L6.44789 14.6292C6.96167 14.1175 7.29478 13.7881 7.57219 13.5772C7.83228 13.3795 7.95393 13.3574 8.03449 13.3574C8.11506 13.3573 8.23672 13.3794 8.49695 13.5769C8.77452 13.7875 9.10787 14.1167 9.62203 14.628L9.89627 14.9007C10.3651 15.367 10.7692 15.7688 11.1362 16.0474C11.5297 16.346 11.9668 16.5719 12.505 16.572C13.0432 16.572 13.4804 16.3462 13.8739 16.0477C14.241 15.7692 14.6452 15.3674 15.1142 14.9013L21.2501 8.80858V7.75H20.1873Z" fill="#267DFF" />
                            </svg>
                        </span>
                            <p class="text-2xl font-bold text-slate-800 dark:text-white">Resumen Financiero</p>
                    </div>
                  
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">

                        <!-- Tarjeta 1: Total Pagado -->
                            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                                <div class="flex items-center gap-2.5 flex-wrap">
                                    <div class="shrink-0 h-[50px] w-[50px] flex items-center justify-center bg-primary/10 rounded-full text-success">
                                        
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.94513 4.25H13.0549C14.4225 4.24998 15.5248 4.24996 16.3918 4.36652C17.2919 4.48754 18.0497 4.74643 18.6517 5.34835C19.2061 5.90277 19.4695 6.58951 19.6022 7.39783C20.4106 7.53047 21.0974 7.79391 21.6519 8.3484C22.2538 8.95032 22.5127 9.70819 22.6337 10.6083C22.7503 11.4753 22.7503 12.5776 22.7503 13.9452V14.0549C22.7503 15.4225 22.7503 16.5248 22.6337 17.3918C22.5127 18.2919 22.2538 19.0498 21.6519 19.6517C21.05 20.2536 20.2921 20.5125 19.392 20.6335C18.525 20.7501 17.4227 20.7501 16.0551 20.7501H10.9454C9.57779 20.7501 8.47547 20.7501 7.6085 20.6335C6.7084 20.5125 5.95052 20.2536 5.3486 19.6517C4.79417 19.0973 4.53072 18.4105 4.39807 17.6022C3.58964 17.4695 2.90283 17.2061 2.34835 16.6517C1.74643 16.0497 1.48754 15.2919 1.36652 14.3918C1.24996 13.5248 1.24998 12.4225 1.25 11.0549V10.9451C1.24998 9.57754 1.24996 8.47522 1.36652 7.60825C1.48754 6.70814 1.74643 5.95027 2.34835 5.34835C2.95027 4.74643 3.70814 4.48754 4.60825 4.36652C5.47522 4.24996 6.57754 4.24998 7.94513 4.25ZM5.95571 17.7316C6.0606 18.1345 6.20999 18.3918 6.40926 18.591C6.68603 18.8678 7.0746 19.0483 7.80837 19.1469C8.56373 19.2485 9.56484 19.2501 11.0003 19.2501H16.0003C17.4357 19.2501 18.4368 19.2485 19.1921 19.1469C19.9259 19.0483 20.3145 18.8678 20.5912 18.591C20.868 18.3143 21.0485 17.9257 21.1471 17.1919C21.2487 16.4366 21.2503 15.4355 21.2503 14.0001C21.2503 12.5646 21.2487 11.5635 21.1471 10.8082C21.0485 10.0744 20.868 9.68583 20.5912 9.40906C20.3919 9.20976 20.1346 9.06034 19.7316 8.95545C19.75 9.54434 19.75 10.206 19.75 10.9451V11.0549C19.75 12.4225 19.75 13.5248 19.6335 14.3918C19.5125 15.2919 19.2536 16.0497 18.6517 16.6517C18.0497 17.2536 17.2919 17.5125 16.3918 17.6335C15.5248 17.75 14.4225 17.75 13.0549 17.75H7.94513C7.2061 17.75 6.54453 17.75 5.95571 17.7316ZM4.80812 5.85315C4.07435 5.9518 3.68577 6.13225 3.40901 6.40901C3.13225 6.68577 2.9518 7.07435 2.85315 7.80812C2.75159 8.56347 2.75 9.56459 2.75 11C2.75 12.4354 2.75159 13.4365 2.85315 14.1919C2.9518 14.9257 3.13225 15.3142 3.40901 15.591C3.68577 15.8678 4.07435 16.0482 4.80812 16.1469C5.56347 16.2484 6.56458 16.25 8 16.25H13C14.4354 16.25 15.4365 16.2484 16.1919 16.1469C16.9257 16.0482 17.3142 15.8678 17.591 15.591C17.8678 15.3142 18.0482 14.9257 18.1469 14.1919C18.2484 13.4365 18.25 12.4354 18.25 11C18.25 9.56459 18.2484 8.56347 18.1469 7.80812C18.0482 7.07435 17.8678 6.68577 17.591 6.40901C17.3142 6.13225 16.9257 5.9518 16.1919 5.85315C15.4365 5.75159 14.4354 5.75 13 5.75H8C6.56458 5.75 5.56347 5.75159 4.80812 5.85315ZM10.5 9.25C9.5335 9.25 8.75 10.0335 8.75 11C8.75 11.9665 9.5335 12.75 10.5 12.75C11.4665 12.75 12.25 11.9665 12.25 11C12.25 10.0335 11.4665 9.25 10.5 9.25ZM7.25 11C7.25 9.20508 8.70508 7.75 10.5 7.75C12.2949 7.75 13.75 9.20508 13.75 11C13.75 12.7949 12.2949 14.25 10.5 14.25C8.70508 14.25 7.25 12.7949 7.25 11ZM5 8.25C5.41421 8.25 5.75 8.58579 5.75 9V13C5.75 13.4142 5.41422 13.75 5 13.75C4.58579 13.75 4.25 13.4142 4.25 13L4.25 9C4.25 8.58579 4.58579 8.25 5 8.25ZM16 8.25C16.4142 8.25 16.75 8.58579 16.75 9V13C16.75 13.4142 16.4142 13.75 16 13.75C15.5858 13.75 15.25 13.4142 15.25 13V9C15.25 8.58579 15.5858 8.25 16 8.25Z" fill="currentColor"/>
                                        </svg>


                                    </div>
                                    <div class="flex items-end gap-3">
                                        <div class="flex-1">
                                            <h4 class="text-lightgray text-sm">TOTAL PAGADO</h4>
                                            <span id="kpi_total_pagos" class="font-bold text-lg mt-1.5">Cargando...</span>
                                        </div>
                                        <div>
                                            <span class="flex items-center text-gray bg-green/10 rounded-full py-1 px-2 gap-1 text-xs font-semibold">3.47%
                                                <svg width="10" height="10" class="inline-block" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M5.73684 9.21053C5.73684 9.64654 5.38338 10 4.94737 10C4.51135 10 4.15789 9.64654 4.15789 9.21053L4.15789 2.69543L2.34772 4.50561C2.03941 4.81392 1.53954 4.81392 1.23123 4.50561C0.922923 4.1973 0.922923 3.69743 1.23123 3.38913L4.38913 0.231232C4.53718 0.0831764 4.73799 -1.83028e-08 4.94737 0C5.15675 1.83066e-08 5.35756 0.0831765 5.50561 0.231232L8.66351 3.38913C8.97181 3.69743 8.97181 4.1973 8.66351 4.50561C8.3552 4.81392 7.85533 4.81392 7.54702 4.50561L5.73684 2.69543V9.21053Z" fill="currentColor" />
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        
                        <!-- Tarjeta 2: Total Gastos -->
                        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                                <div class="flex items-center gap-2.5 flex-wrap">
                                    <div class="shrink-0 h-[50px] w-[50px] flex items-center justify-center bg-pink/10 rounded-full text-pink">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M2 14C2 10.2288 2 8.34315 3.17157 7.17157C4.34315 6 6.22876 6 10 6H14C17.7712 6 19.6569 6 20.8284 7.17157C22 8.34315 22 10.2288 22 14C22 17.7712 22 19.6569 20.8284 20.8284C19.6569 22 17.7712 22 14 22H10C6.22876 22 4.34315 22 3.17157 20.8284C2 19.6569 2 17.7712 2 14Z" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M16 6C16 4.11438 16 3.17157 15.4142 2.58579C14.8284 2 13.8856 2 12 2C10.1144 2 9.17157 2 8.58579 2.58579C8 3.17157 8 4.11438 8 6" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M12 17.3333C13.1046 17.3333 14 16.5871 14 15.6667C14 14.7462 13.1046 14 12 14C10.8954 14 10 13.2538 10 12.3333C10 11.4129 10.8954 10.6667 12 10.6667M12 17.3333C10.8954 17.3333 10 16.5871 10 15.6667M12 17.3333V18M12 10V10.6667M12 10.6667C13.1046 10.6667 14 11.4129 14 12.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                        </svg>

                                    </div>
                                    <div class="flex items-end gap-3">
                                        <div class="flex-1">
                                            <h4 class="text-lightgray text-sm">TOTAL GASTOS</h4>
                                            <span id="kpi_total_gastos" class="font-bold text-lg mt-1.5">Cargando...</span>
                                        </div>
                                        <div>
                                            <span class="flex items-center text-gray bg-gray/10 rounded-full py-1 px-2 gap-1 text-xs font-semibold">9.69%
                                                <svg width="10" height="10" class="inline-block" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M5.73684 9.21053C5.73684 9.64654 5.38338 10 4.94737 10C4.51135 10 4.15789 9.64654 4.15789 9.21053L4.15789 2.69543L2.34772 4.50561C2.03941 4.81392 1.53954 4.81392 1.23123 4.50561C0.922923 4.1973 0.922923 3.69743 1.23123 3.38913L4.38913 0.231232C4.53718 0.0831764 4.73799 -1.83028e-08 4.94737 0C5.15675 1.83066e-08 5.35756 0.0831765 5.50561 0.231232L8.66351 3.38913C8.97181 3.69743 8.97181 4.1973 8.66351 4.50561C8.3552 4.81392 7.85533 4.81392 7.54702 4.50561L5.73684 2.69543V9.21053Z" fill="currentColor" />
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        

                        <!-- Tarjeta 3: Por Pagar -->
                         <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                                <div class="flex items-center gap-2.5 flex-wrap">
                                    <div class="shrink-0 h-[50px] w-[50px] flex items-center justify-center bg-orange/10 rounded-full text-orange">
                                       <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle opacity="0.5" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                                            <path d="M12 7V13" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                                            <circle cx="12" cy="16" r="1" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div class="flex items-end gap-3">
                                        <div class="flex-1">
                                            <h4 class="text-lightgray text-sm">POR PAGAR</h4>
                                            <span id="kpi_pendiente" class="font-bold text-lg mt-1.5">Cargando...</span>
                                        </div>
                                        <div>
                                            <span class="flex items-center text-gray bg-gray/10 rounded-full py-1 px-2 gap-1 text-xs font-semibold">2.58%
                                                <svg width="10" height="10" class="inline-block rotate-180" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M5.73684 9.21053C5.73684 9.64654 5.38338 10 4.94737 10C4.51135 10 4.15789 9.64654 4.15789 9.21053L4.15789 2.69543L2.34772 4.50561C2.03941 4.81392 1.53954 4.81392 1.23123 4.50561C0.922923 4.1973 0.922923 3.69743 1.23123 3.38913L4.38913 0.231232C4.53718 0.0831764 4.73799 -1.83028e-08 4.94737 0C5.15675 1.83066e-08 5.35756 0.0831765 5.50561 0.231232L8.66351 3.38913C8.97181 3.69743 8.97181 4.1973 8.66351 4.50561C8.3552 4.81392 7.85533 4.81392 7.54702 4.50561L5.73684 2.69543V9.21053Z" fill="currentColor" />
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <div class="mb-[30px] flex items-center flex-wrap justify-between">
                    <h2 class="font-semibold">Tendencias de Gastos Diarios</h2>

                    <div class="flex items-center gap-2">
                        <input id="tendencia_inicio" type="date" class="form-input rounded-lg w-33 text-sm" 
                            onchange="updateTendenciaGastos()">
                        <span class="text-gray-500 text-sm">a</span>
                        <input id="tendencia_fin" type="date" class="form-input rounded-lg w-33 text-sm" 
                            onchange="updateTendenciaGastos()">
                    </div>
                </div>

                <div id="grafica_tendencias"></div>
                
            </div>
                                
                <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                    <h2 class="mb-[30px] font-semibold">Distribución de Gastos</h2>
                <div id="distribucion-gastos-barras"></div>
        </div>

        </div>
        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Detalle de Gasto</h2>
                <div id="resumen"></div>
        </div>

         <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Detalle de Gasto por Categoría</h2>
                <div id="distribucion_gasto"></div>
        </div>
       
        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
            <h2 class="font-semibold text-slate-800 dark:text-white">Egresos Mensuales</h2>
            <span class="text-lightgray text-sm">$MXN</span>       
            <div id="grafica_pagos_mensuales"></div>
        </div>
        <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Detalle de Pago</h2>
                <div id="egresos"></div>
        </div>
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Compras mensuales por producto</h2>
                <div id="grafica_ejemplo"></div>
            </div>
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                <h2 class="mb-[30px] font-semibold">Detalle de compra</h2>
                <div id="detalle_compras"></div>
            </div>
        </div>
      
        <div class="grid grid-cols-1 xl:grid-cols-1 gap-5">
            <div class="bg-white dark:bg-dark dark:border-gray/20 border-2 border-lightgray/10 p-5 rounded-lg">
                    <div class="flex justify-between items-center gap-3">
                        <div class="flex flex-col">
                            <h2 class="font-semibold">Compras diarias</h2>
                            <span class="text-lightgray text-sm">$MXN</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="compras_diarias_inicio" value="{{fecha_inicio}}" type="date" class="form-input rounded-lg w-full" value="{{fecha_inicio}}" onchange="updateComprasDiarias()"> a
                            <input id="compras_diarias_fin" value="{{fecha_fin}}" type="date" class="form-input rounded-lg w-full" value="{{fecha_fin}}" onchange="updateComprasDiarias()">
                        </div>
                    </div>
                    <div id="grafica_compras_diarias"></div>
            </div>
           
        </div> 
               
    </div>
    {% include "./partials/system/loader.html" %}
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts@latest"></script>
<script src="/static/js/system/apex-ecom_copy.js"></script>
<script src="/static/js/system/funciones_generales.js"></script>
<script src="/static/js/charts/general.js"></script>
<script src="/static/js/charts/waterfall.js"></script>
<script src="/static/js/charts/template.js"></script>
<script>

    
    async function cargarKPIs() {
        const inicio = document.getElementById('compras_diarias_inicio').value;
        const fin = document.getElementById('compras_diarias_fin').value;
        
        const url = `/dashboard_queries/resumen_financiero?fecha_inicio=${inicio}&fecha_fin=${fin}`;
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            

            if (data && data.length > 0) {
                const res = data[0];
                
                const gastos = parseFloat(res.total_gastos || 0);
                const pagos = parseFloat(res.total_pagos || 0);
                const pendiente = gastos - pagos;

                const formatter = new Intl.NumberFormat('es-MX', {
                    style: 'currency',
                    currency: 'MXN'
                });

                document.getElementById('kpi_total_gastos').innerText = formatter.format(gastos);
                document.getElementById('kpi_total_pagos').innerText = formatter.format(pagos);
                document.getElementById('kpi_pendiente').innerText = formatter.format(pendiente);
            }
        } catch (error) {
            console.error("Error cargando los números:", error);
        }
    }
        generar_grafica_categorias("#grafica_ejemplo", "bar_stacked",'mes_anio','importe_total','producto','/dashboard_queries/compras_mensuales',options={height:400,valueType: 'currency'})
            function updateComprasDiarias() {
                const compras_diarias_inicio = document.getElementById('compras_diarias_inicio').value;
                const compras_diarias_fin = document.getElementById('compras_diarias_fin').value;
                generar_grafica(
                    '#grafica_compras_diarias',
                    'line',
                    'fecha',
                    'importe_total',
                    `/dashboard_queries/compras_diarias?fecha_inicio=${compras_diarias_inicio}&fecha_fin=${compras_diarias_fin}`,{'valueType':'currency'}
                )
        }
        function updateTendenciaGastos() {
            const inicio = document.getElementById('tendencia_inicio').value || document.getElementById('compras_diarias_inicio').value;
            const fin = document.getElementById('tendencia_fin').value || document.getElementById('compras_diarias_fin').value;

            const url = `/dashboard_queries/gastos_fechas?fecha_inicio=${inicio}&fecha_fin=${fin}`;
            
            const container = document.getElementById('grafica_tendencias');
            if (container) {
                container.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        mostrarSinDatos('#grafica_tendencias');
                        return;
                    }
                    
                    renderizarTendenciaEstilo(data);
                })
                .catch(error => {
                    console.error('Error cargando tendencia:', error);
                    mostrarError('#grafica_tendencias');
                });
        }

       function renderizarTendenciaEstilo(datos) {
        const fechas = datos.map(d => {
            const fecha = new Date(d.fecha);
            return fecha.toLocaleDateString('es-MX', {
                day: '2-digit',
                month: 'short'
            });
        });
        
        const valores = datos.map(d => parseFloat(d.total_gastos) || 0);
        
        const maxValor = Math.max(...valores);
        const minValor = Math.min(...valores);
        const yMax = Math.ceil(maxValor / 100) * 100; 
        const yMin = Math.floor(minValor / 100) * 100; 
        
        const options = {
            series: [{
                name: "Gastos",
                data: valores
            }],
            chart: {
                type: "line",  
                height: 300,
                fontFamily: "Inter, sans-serif",
                zoom: {
                    enabled: false,
                },
                toolbar: {
                    show: false,
                },
                animations: {
                    enabled: true,
                    speed: 800
                }
            },
            dataLabels: {
                enabled: false,
            },
            stroke: {
                show: true,
                curve: "smooth",
                width: 3,
                lineCap: "square",
            },
            colors: ["#267DFF"],
            markers: {
                size: 5, 
                colors: ["#267DFF"],
                strokeColors: "#fff",
                strokeWidth: 2,
                hover: {
                    size: 7
                }
            },
            labels: fechas,
            xaxis: {
                axisBorder: {
                    show: false,
                },
                axisTicks: {
                    show: false,
                },
                crosshairs: {
                    show: true,
                    position: 'back',
                    stroke: {
                        color: '#e0e6ed',
                        width: 1,
                        dashArray: 0,
                    }
                },
                labels: {
                    offsetX: 0,
                    offsetY: 5,
                    style: {
                        fontSize: "14px",
                        fontWeight: "600",
                        colors: "#7780A1",
                        cssClass: "apexcharts-xaxis-title",
                    },
                },
                tooltip: {
                    enabled: false
                }
            },
            yaxis: {
                min: yMin,
                max: yMax,
                tickAmount: Math.floor((yMax - yMin) / 100),
                labels: {
                    formatter: function(value) {
                        return new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(value);
                    },
                    offsetX: -10,
                    offsetY: 0,
                    style: {
                        fontSize: "14px",
                        fontWeight: "600",
                        colors: "#7780A1",
                        cssClass: "apexcharts-yaxis-title",
                    },
                },
                opposite: false,
            },
            grid: {
                borderColor: "#e0e6ed",
                strokeDashArray: 7,
                xaxis: {
                    lines: {
                        show: true,
                    },
                },
                yaxis: {
                    lines: {
                        show: false,
                    },
                },
                padding: {
                    top: 0,
                    right: 0,
                    bottom: 0,
                    left: 25,
                },
            },
            legend: {
                show: false
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function (value) {
                        return new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN',
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }).format(value);
                    }
                },
                style: {
                    fontSize: '12px',
                    fontFamily: 'Inter, sans-serif'
                }
            }
        };
        
        if (window.tendenciaGastosChart) {
            window.tendenciaGastosChart.destroy();
        }
        
        const chartElement = document.querySelector("#grafica_tendencias");
        chartElement.innerHTML = ''; 
        
        window.tendenciaGastosChart = new ApexCharts(chartElement, options);
        window.tendenciaGastosChart.render();
    }

        function updateDistribucionGastosBarras() {
            const inicio = document.getElementById('compras_diarias_inicio').value;
            const fin = document.getElementById('compras_diarias_fin').value;
            
            const url = `/dashboard_queries/gastos_por_categoria?fecha_inicio=${inicio}&fecha_fin=${fin}`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        mostrarSinDatos('#distribucion-gastos-barras');
                        return;
                    }
                    
                    const categorias = data.map(d => d.categoria);
                    const montos = data.map(d => parseFloat(d.total) || 0);
                    
                    const options = {
                        chart: {
                            height: 300, 
                            type: "bar",
                            fontFamily: "Inter, sans-serif",
                            zoom: { enabled: false },
                            toolbar: { show: false }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: false,
                                endingShape: "rounded",  
                                columnWidth: "50%",      
                                borderRadius: 5,         
                            },
                        },
                        stroke: {
                            show: true,
                            width: 4,
                            colors: ["transparent"], 
                        },
                        colors: ["#267DFF"],  
                        series: [{
                            name: "Monto",
                            data: montos
                        }],
                        dataLabels: {
                            enabled: false, 
                        },
                        legend: {
                            show: false,  
                        },
                        xaxis: {
                            categories: categorias,
                            axisBorder: {
                                show: false,
                            },
                            axisTicks: {
                                show: false,
                            },
                            crosshairs: {
                                show: true,
                            },
                            labels: {
                                offsetX: 0,
                                offsetY: 5,
                                style: {
                                    fontSize: "16px",  
                                    fontWeight: "600",
                                    colors: "#7780A1",
                                    cssClass: "apexcharts-xaxis-title",
                                },
                            },
                        },
                        yaxis: {
                            show: false,  
                        },
                        fill: { 
                            opacity: 1 
                        },
                        grid: {
                            borderColor: "#e0e6ed",
                            strokeDashArray: 7,
                            xaxis: {
                                lines: {
                                    show: false,
                                },
                            },
                            yaxis: {
                                lines: {
                                    show: false, 
                                },
                            },
                            padding: {
                                top: 0,
                                right: 0,
                                bottom: 0,
                                left: 0,
                            },
                        },
                        tooltip: {
                            y: {
                                formatter: function(val) {
                                    return '$' + new Intl.NumberFormat('es-MX').format(val);
                                }
                            }
                        }
                    };
                    
                    if (window.distribucionGastosBarChart) {
                        window.distribucionGastosBarChart.destroy();
                    }
                    
                    const chartElement = document.querySelector("#distribucion-gastos-barras");
                    if (chartElement) {
                        chartElement.innerHTML = '';
                        
                        window.distribucionGastosBarChart = new ApexCharts(chartElement, options);
                        window.distribucionGastosBarChart.render();
                    }
                })
                .catch(error => {
                    console.error('Error cargando distribución de gastos:', error);
                    mostrarError('#distribucion-gastos-barras');
                });
        }

        function inicializarFechas() {
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            const formato = (fecha) => fecha.toISOString().split('T')[0];
            
            const fechaInicio = formato(hace30Dias);
            const fechaFin = formato(hoy);
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.id.includes('inicio')) {
                    input.value = fechaInicio;
                } else if (input.id.includes('fin')) {
                    input.value = fechaFin;
                }
            });
        }

        function configurarSincronizacionFechas() {
            const inputs = [
                'compras_diarias_inicio',
                'compras_diarias_fin',
                'tendencia_inicio', 
                'tendencia_fin'
            ];
            
            inputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', function() {
                        if (id.includes('tendencia')) {
                            updateTendenciaGastos();
                        } else if (id.includes('compras_diarias')) {
                            updateComprasDiarias();
                            renderizarTendenciaEstilo()
                            updateDistribucionGastosBarras();
                            cargarKPIs();
                        }
                    });
                }
            });
        }
        
      function updatePagosMensuales() {
    const inicio = document.getElementById('compras_diarias_inicio').value;
    const fin = document.getElementById('compras_diarias_fin').value;
    const url = `/dashboard_queries/pagos_por_mes?fecha_inicio=${inicio}&fecha_fin=${fin}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (!data || data.length === 0) {
                mostrarSinDatos('#grafica_pagos_mensuales');
                return;
            }
            
            const meses = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const datosOrdenados = [...data].sort((a, b) => 
                meses.indexOf(a.mes) - meses.indexOf(b.mes)
            );
            
            const x = datosOrdenados.map(item => item.mes);
            const y = datosOrdenados.map(item => parseFloat(item.total_pagado) || 0);
            
            const maxValor = Math.max(...y);
            const yMax = Math.ceil(maxValor / 500) * 500; 
            
            const options = {
                series: [{
                    name: 'Egresos',
                    data: y
                }],
                chart: {
                    type: 'bar',
                    height: 350,
                    fontFamily: "Inter, sans-serif",
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: false
                    },
                    animations: {
                        enabled: true, 
                        speed: 800
                    }
                },
                plotOptions: {
                    bar: {
                        borderRadius: 6,
                        columnWidth: '40%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#267DFF'],
                dataLabels: {
                    enabled: true,
                    offsetY: -20,
                    style: {
                        fontSize: "11px", 
                        fontWeight: "600", 
                        colors: ["#fff"],
                    },
                    formatter: function(val) {
                        return new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: 'MXN',
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(val);
                    }
                },
                xaxis: {
                    categories: x,
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    labels: {
                        style: {
                            fontSize: "14px", 
                            fontWeight: "600", 
                            colors: "#7780A1", 
                            cssClass: "apexcharts-xaxis-title",
                        }
                    }
                },
                yaxis: {
                    min: 0,
                    max: yMax,
                    tickAmount: 5,
                    labels: {
                        style: {
                            fontSize: "14px", 
                            fontWeight: "600", 
                            colors: "#7780A1", 
                            cssClass: "apexcharts-yaxis-title",
                        },
                        formatter: function(value) {
                            return new Intl.NumberFormat('es-MX', {
                                style: 'currency',
                                currency: 'MXN',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).format(value);
                        },
                        offsetX: -10, 
                        offsetY: 0,
                    },
                    title: {
                        style: {
                            color: '#7780A1',
                            fontSize: '12px',
                            fontWeight: 400
                        }
                    }
                },
                grid: {
                    borderColor: '#e0e6ed',
                    strokeDashArray: 5,
                    xaxis: {
                        lines: {
                            show: true
                        }
                    },
                    yaxis: {
                        lines: {
                            show: true
                        }
                    }
                },
                tooltip: {
                    y: {
                        formatter: function(value) {
                            return new Intl.NumberFormat('es-MX', {
                                style: 'currency',
                                currency: 'MXN',
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }).format(value);
                        }
                    },
                    style: {
                        fontSize: '12px',
                        fontFamily: 'Inter, sans-serif' 
                    }
                }
            };
            
            if (window.egresosMensualesChart) {
                window.egresosMensualesChart.destroy();
            }
            
            const chartElement = document.querySelector("#grafica_pagos_mensuales");
            if (chartElement) {
                chartElement.innerHTML = '';
                window.egresosMensualesChart = new ApexCharts(chartElement, options);
                window.egresosMensualesChart.render();
            }
        })
        .catch(error => {
            console.error('Error cargando pagos mensuales:', error);
            mostrarError('#grafica_pagos_mensuales');
            
            generar_grafica_categorias(
                "#grafica_pagos_mensuales", 
                "bar_stacked",           
                "mes",           
                "total_pagado",  
                "mes", 
                "/dashboard_queries/pagos_por_mes", 
                {
                    height: 350,
                    valueType: 'currency',
                    colors: ["#267DFF"], 
                    plotOptions: {
                        bar: {
                            borderRadius: 6,
                            columnWidth: '40%', 
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    legend: {
                        show: false 
                    },
                    chart: {
                        fontFamily: "Inter, sans-serif"
                    },
                    xaxis: {
                        labels: {
                            style: {
                                fontSize: "14px",
                                fontWeight: "600",
                                colors: "#7780A1"
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontSize: "14px",
                                fontWeight: "600",
                                colors: "#7780A1"
                            }
                        }
                    }
                }
            );
        });
}
        inicializarFechas();
        configurarSincronizacionFechas()
        updateTendenciaGastos()
        updateComprasDiarias()
        updatePagosMensuales()
        updateDistribucionGastosBarras();
        document.addEventListener('DOMContentLoaded', () => {
        cargarKPIs(); 
        render_dynamic_table("detalle_compras", '/dashboard_queries/tables?path=compras')
        render_dynamic_table("resumen", '/dashboard_queries/tables?path=gastos_fechas')
        render_dynamic_table("distribucion_gasto", '/dashboard_queries/tables?path=gastos_fechas')
        render_dynamic_table("egresos", '/dashboard_queries/tables?path=pagos_por_mes')

});
</script>
{% endblock content %}